<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>#MyNOSESHOPãƒ•ã‚©ãƒˆã‚³ãƒ³ãƒ†ã‚¹ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff; 
            color: #333; 
        }
        .header-background { 
            background-color: #f8f8f8; 
            border-bottom: 1px solid #eee;
        }
        .btn-primary { 
            background-color: #000;
            color: white;
            border: 1px solid #000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #333;
            border-color: #333;
        }
        .btn-secondary { 
            background-color: transparent;
            color: #555;
            border: 1px solid #ccc;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #f0f0f0;
            border-color: #bbb;
        }
        .btn-secondary.active { /* é¸æŠä¸­ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background-color: #333;
            color: white;
            border-color: #333;
        }

        .carousel-container {
            overflow: hidden;
            width: 100%;
        }
        .carousel-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .carousel-item {
            /* min-widthã‚’Tailwindã‚¯ãƒ©ã‚¹ã§è¨­å®š */
            flex-shrink: 0;
            margin-right: 1rem; /* 16px */
            scroll-snap-align: start;
        }
        .gallery-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
            border: 1px solid #eee; 
            overflow: hidden;
        }
        .gallery-card img {
            width: 100%;
            height: 180px; /* ã‚¹ãƒãƒ›å‘ã‘ã«å°‘ã—é«˜ã•ã‚’èª¿æ•´ */
            sm:height: 200px;
            object-fit: cover;
        }
        .category-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; 
            font-size: 0.75rem;
            font-weight: 600;
            border-width: 1px;
        }
        .category-cool { border-color: #a5b4fc; color: #4f46e5; background-color: #e0e7ff50; }
        .category-pop { border-color: #fcd34d; color: #d97706; background-color: #fef3c750; }
        .category-natural { border-color: #86efac; color: #15803d; background-color: #dcfce750; }
        .category-other { border-color: #d1d5db; color: #4b5563; background-color: #f3f4f650; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; text-align: center; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .focus-ring-black:focus { outline-color: #333; --tw-ring-color: #333; }
    </style>
</head>
<body class="text-gray-800">

    <header class="header-background p-4 sm:p-6 text-center shadow-sm">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-black">#MyNOSESHOPãƒ•ã‚©ãƒˆã‚³ãƒ³ãƒ†ã‚¹ãƒˆ</h1>
        <p class="mt-2 text-sm sm:text-base md:text-lg text-gray-600">ãŠæ°—ã«å…¥ã‚Šã®é¦™æ°´ã¨æ—¥å¸¸ã®ã‚·ãƒ¼ãƒ³ã‚’æŠ•ç¨¿ã—ã‚ˆã†ï¼</p>
    </header>

    <main class="container mx-auto px-3 py-4 sm:px-4 md:px-8 md:py-8">

        <section id="submission-form-section" class="mb-8 sm:mb-12 p-4 sm:p-6 bg-white rounded-lg shadow-md border border-gray-200">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-center text-black">ä½œå“ã‚’å¿œå‹Ÿã™ã‚‹</h2>
            <form id="photoContestForm" class="space-y-4 sm:space-y-6">
                <div>
                    <label for="twitterAccount" class="block text-sm font-medium text-gray-700">Twitterã‚¢ã‚«ã‚¦ãƒ³ãƒˆå (ä¾‹: @NOSESHOP_JP)</label>
                    <input type="text" name="twitterAccount" id="twitterAccount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm" placeholder="@ã‚ãªãŸã®TwitterID">
                </div>
                <div>
                    <label for="photoFile" class="block text-sm font-medium text-gray-700">å†™çœŸ (é¦™æ°´ã¨æ—¥å¸¸ãŒãƒ†ãƒ¼ãƒ)</label>
                    <input type="file" name="photoFile" id="photoFile" accept="image/*" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:sm:text-sm file:font-semibold file:bg-gray-100 file:text-black hover:file:bg-gray-200 focus-ring-black">
                    <img id="imagePreview" src="#" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" class="mt-2 rounded-md max-h-40 sm:max-h-48 hidden"/>
                </div>
                <div>
                    <label for="photoTitle" class="block text-sm font-medium text-gray-700">ä½œå“ã®é¡Œå</label>
                    <input type="text" name="photoTitle" id="photoTitle" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm" placeholder="ç´ æ•µãªä½œå“ã®ã‚¿ã‚¤ãƒˆãƒ«">
                </div>
                <div>
                    <label for="photoComment" class="block text-sm font-medium text-gray-700">ã‚³ãƒ¡ãƒ³ãƒˆ (ä»»æ„)</label>
                    <textarea name="photoComment" id="photoComment" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm" placeholder="ä½œå“ã«è¾¼ã‚ãŸæƒ³ã„ãªã©"></textarea>
                </div>
                 <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select name="category" id="category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-black focus:border-black sm:text-sm">
                        <option value="cool">ã‚¯ãƒ¼ãƒ«</option>
                        <option value="pop">ãƒãƒƒãƒ—</option>
                        <option value="natural">ãƒŠãƒãƒ¥ãƒ©ãƒ«</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                </div>
                <button type="submit" class="w-full btn-primary font-semibold py-2.5 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 text-base">å¿œå‹Ÿã™ã‚‹</button>
            </form>
        </section>

        <section id="gallery-section" class="mb-8 sm:mb-12">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-center text-black">ã¿ã‚“ãªã®æŠ•ç¨¿ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
            
            <div class="mb-4 sm:mb-6 text-center flex flex-wrap justify-center gap-1 sm:gap-2">
                <button class="btn-secondary category-filter-btn py-1.5 px-2.5 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-md" data-category="all">ã™ã¹ã¦</button>
                <button class="btn-secondary category-filter-btn py-1.5 px-2.5 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-md" data-category="new">æ–°ç€ä½œå“</button>
                <button class="btn-secondary category-filter-btn py-1.5 px-2.5 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-md" data-category="cool">ã‚¯ãƒ¼ãƒ«</button>
                <button class="btn-secondary category-filter-btn py-1.5 px-2.5 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-md" data-category="pop">ãƒãƒƒãƒ—</button>
                <button class="btn-secondary category-filter-btn py-1.5 px-2.5 text-xs sm:py-2 sm:px-4 sm:text-sm rounded-md" data-category="natural">ãƒŠãƒãƒ¥ãƒ©ãƒ«</button>
            </div>

            <div id="carouselContainer" class="carousel-container relative"> {/* group class removed as nav buttons are always visible */}
                <div id="carouselTrack" class="carousel-track">
                    </div>
                <button id="prevBtn" class="absolute top-1/2 left-1 transform -translate-y-1/2 bg-white bg-opacity-60 hover:bg-opacity-90 p-1 sm:p-2 rounded-full shadow-md z-10 focus-ring-black">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-black">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <button id="nextBtn" class="absolute top-1/2 right-1 transform -translate-y-1/2 bg-white bg-opacity-60 hover:bg-opacity-90 p-1 sm:p-2 rounded-full shadow-md z-10 focus-ring-black">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-black">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                    </svg>
                </button>
            </div>
             <p class="text-xs text-gray-500 mt-2 text-center">â€» ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã¯è‡ªå‹•ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¾ã™ã€‚ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼ã§ä¸€æ™‚åœæ­¢ã—ã¾ã™ã€‚</p>
        </section>

        <section id="present-info" class="p-4 sm:p-6 bg-white rounded-lg shadow-md border border-gray-200">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 sm:mb-6 text-center text-black">è±ªè¯ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ</h2>
            <div class="space-y-4 text-gray-700">
                <div class="p-3 sm:p-4 border border-gray-300 rounded-md bg-gray-50">
                    <h3 class="font-semibold text-base sm:text-lg text-black">ğŸ† æœ€å¤šå¾—ç¥¨è³ (1åæ§˜)</h3>
                    <p class="text-sm sm:text-base">ãŠå¥½ããªé¦™æ°´ã‚’1æœ¬ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆï¼ãƒ­ãƒ¼ãƒ³ãƒäºˆå®šã®æ–°ãƒ–ãƒ©ãƒ³ãƒ‰ã®é¦™æ°´ã‚‚ãŠé¸ã³ã„ãŸã ã‘ã¾ã™ã€‚</p>
                </div>
                <div class="p-3 sm:p-4 border border-gray-300 rounded-md bg-gray-50">
                    <h3 class="font-semibold text-base sm:text-lg text-black">ğŸ æŠ•ç¥¨å‚åŠ è³ (æŠ½é¸ã§è¤‡æ•°åæ§˜)</h3>
                    <p class="text-sm sm:text-base">å†™çœŸæŠ•ç¨¿ã¯ã›ãšæŠ•ç¥¨ã ã‘ã§ã‚‚å‚åŠ OKï¼NOSESHOPã®ç´ æ•µãªã‚¢ã‚¤ãƒ†ãƒ ã‚’æŠ½é¸ã§ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã—ã¾ã™ã€‚</p>
                    <p class="text-xs sm:text-sm mt-1">â€» ã¾ã NOSESHOPã®é¦™æ°´ã‚’æŒã£ã¦ã„ãªã„æ–¹ã‚‚ã€ãœã²ãŠæ°—è»½ã«ã”å‚åŠ ãã ã•ã„ï¼</p>
                </div>
            </div>
            <p class="mt-4 sm:mt-6 text-center text-xs sm:text-sm text-gray-600">
                çµæœç™ºè¡¨ã¯NOSESHOPå…¬å¼ã‚µã‚¤ãƒˆãŠã‚ˆã³SNSã«ã¦è¡Œã„ã¾ã™ã€‚ãŠæ¥½ã—ã¿ã«ï¼
            </p>
        </section>
    </main>

    <footer class="mt-8 sm:mt-12 p-4 sm:p-6 bg-gray-100 text-center border-t border-gray-200">
        <p class="text-xs sm:text-sm text-gray-600">&copy; 2025 NOSESHOP. All Rights Reserved.</p>
        <p class="text-xs text-gray-500 mt-1">ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ‡ãƒ¢ç”¨ã«ä½œæˆã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚</p>
    </footer>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modalMessageText" class="text-sm sm:text-base"></p>
            <button onclick="closeModal()" class="mt-4 btn-primary py-2 px-4 rounded-md text-sm sm:text-base">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»å®šæ•° ---
        const photoContestForm = document.getElementById('photoContestForm');
        const imagePreview = document.getElementById('imagePreview');
        const photoFileInp = document.getElementById('photoFile');
        const carouselContainer = document.getElementById('carouselContainer');
        const carouselTrack = document.getElementById('carouselTrack');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const categoryFilterBtns = document.querySelectorAll('.category-filter-btn');
        const modal = document.getElementById('messageModal');
        const modalMessageText = document.getElementById('modalMessageText');

        let submissions = [
            { id: 1, twitter: '@perfume_lover', imageUrl: 'https://placehold.co/300x200/e0e0e0/333333?text=é¦™ã‚Šã®æœ', title: 'é¦™ã‚Šã®æœ', comment: 'ãŠæ°—ã«å…¥ã‚Šã®é¦™æ°´ã¨æœã®ã‚³ãƒ¼ãƒ’ãƒ¼ã€‚æœ€é«˜ã®1æ—¥ã®å§‹ã¾ã‚Šã§ã™ã€‚', votes: 15, category: 'natural', timestamp: new Date('2025-05-01T10:00:00Z') },
            { id: 2, twitter: '@daily_scent', imageUrl: 'https://placehold.co/300x200/e0e0e0/333333?text=èª­æ›¸ã¨ç§', title: 'èª­æ›¸ã¨ç§ã®ãŠä¾›', comment: 'é™ã‹ãªåˆå¾Œã®èª­æ›¸ã‚¿ã‚¤ãƒ ã€‚ã“ã®é¦™ã‚ŠãŒè½ã¡ç€ãã¾ã™ã€‚', votes: 22, category: 'cool', timestamp: new Date('2025-05-02T14:30:00Z') },
            { id: 3, twitter: '@art_fragrance', imageUrl: 'https://placehold.co/300x200/e0e0e0/333333?text=è¡—è§’ã‚¹ãƒŠãƒƒãƒ—', title: 'è¡—è§’ã‚¹ãƒŠãƒƒãƒ—', comment: 'éƒ½å¸‚ã®å–§é¨’ã¨ã€ãµã‚ã‚Šã¨é¦™ã‚‹è‡ªç”±ãªæ°—åˆ†ã€‚', votes: 8, category: 'pop', timestamp: new Date('2025-05-03T18:00:00Z') },
            { id: 4, twitter: '@noseshop_fan', imageUrl: 'https://placehold.co/300x200/e0e0e0/333333?text=å…¬åœ’ã®ã²ã¨ã¨ã', title: 'å…¬åœ’ã®ã²ã¨ã¨ã', comment: 'ç·‘ã®ä¸­ã§æ·±å‘¼å¸ã€‚è‡ªç„¶ã¨èª¿å’Œã™ã‚‹é¦™ã‚Šã€‚', votes: 30, category: 'natural', timestamp: new Date('2025-05-04T12:15:00Z') },
            { id: 5, twitter: '@happy_aroma', imageUrl: 'https://placehold.co/300x200/e0e0e0/333333?text=ã‚«ãƒ©ãƒ•ãƒ«ãƒ©ã‚¤ãƒ•', title: 'ã‚«ãƒ©ãƒ•ãƒ«ãƒ©ã‚¤ãƒ•', comment: 'ãƒãƒƒãƒ—ãªé¦™ã‚Šã§æ¯æ—¥ã‚’æ¥½ã—ãï¼ãŠå‡ºã‹ã‘å‰ã®å¿…éœ€å“ã€‚', votes: 12, category: 'pop', timestamp: new Date('2025-05-05T09:00:00Z') },
            { id: 6, twitter: '@calm_moment', imageUrl: 'https://placehold.co/300x200/e0e0e0/333333?text=å¤œã®é™å¯‚', title: 'å¤œã®é™å¯‚ã¨é¦™ã‚Š', comment: 'ä¸€æ—¥ã®çµ‚ã‚ã‚Šã«ã€ã“ã®é¦™ã‚Šã§ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€‚', votes: 18, category: 'cool', timestamp: new Date('2025-05-06T22:00:00Z') },
        ];

        let currentFilter = 'all';
        let autoScrollInterval;
        let currentTrackPosition = 0;
        let calculatedItemWidthAndMargin = 316; // Default, will be calculated
        let numberOfOriginalItemsInCarousel = 0;

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        photoFileInp.addEventListener('change', function(event) {
            if (event.target.files && event.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                }
                reader.readAsDataURL(event.target.files[0]);
            } else {
                imagePreview.src = "#";
                imagePreview.classList.add('hidden');
            }
        });
        
        photoContestForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const twitterAccount = document.getElementById('twitterAccount').value;
            const photoFile = document.getElementById('photoFile').files[0];
            const photoTitle = document.getElementById('photoTitle').value;
            const photoComment = document.getElementById('photoComment').value;
            const category = document.getElementById('category').value;

            if (!twitterAccount || !photoFile || !photoTitle || !category) {
                showMessageModal("å¿…é ˆé …ç›®ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const newSubmission = {
                    id: submissions.length + 1 + Math.floor(Math.random()*1000),
                    twitter: twitterAccount,
                    imageUrl: e.target.result,
                    title: photoTitle,
                    comment: photoComment,
                    votes: 0,
                    category: category,
                    timestamp: new Date()
                };
                submissions.unshift(newSubmission);
                renderGallery();
                showMessageModal("å¿œå‹ŸãŒå®Œäº†ã—ã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚");
                photoContestForm.reset();
                imagePreview.classList.add('hidden');
            };
            reader.readAsDataURL(photoFile);
        });

        categoryFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentFilter = btn.getAttribute('data-category');
                document.querySelector('.category-filter-btn.active')?.classList.remove('active');
                btn.classList.add('active');
                renderGallery();
            });
        });
        
        prevBtn.addEventListener('click', () => {
            if (numberOfOriginalItemsInCarousel === 0) return;
            currentTrackPosition += calculatedItemWidthAndMargin;
            if (currentTrackPosition > 0) {
                currentTrackPosition = 0;
            }
            carouselTrack.style.transform = `translateX(${currentTrackPosition}px)`;
            stopAutoScroll();
            startAutoScroll(); 
        });

        nextBtn.addEventListener('click', () => {
            if (numberOfOriginalItemsInCarousel === 0) return;
            moveToNextSlide(); // This already calls stop/start if needed or handles loop
            stopAutoScroll();
            startAutoScroll();
        });

        carouselContainer.addEventListener('mouseenter', stopAutoScroll);
        carouselContainer.addEventListener('mouseleave', startAutoScroll);

        // --- é–¢æ•° ---
        function showMessageModal(message) {
            modalMessageText.textContent = message;
            modal.style.display = "block";
        }

        function closeModal() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }
        
        function calculateDynamicItemWidth() {
            if (carouselTrack.children.length > 0) {
                const firstItem = carouselTrack.children[0];
                const style = window.getComputedStyle(firstItem);
                const marginRight = parseFloat(style.marginRight) || 0; // Ensure it's a number
                return firstItem.offsetWidth + marginRight;
            }
            return 316; // Fallback: 300px item width + 16px margin
        }

        function renderGallery() {
            stopAutoScroll(); 
            carouselTrack.innerHTML = '';
            let filteredSubmissions = submissions;

            if (currentFilter === 'new') {
                filteredSubmissions = [...submissions].sort((a, b) => b.timestamp - a.timestamp);
            } else if (currentFilter !== 'all') {
                filteredSubmissions = submissions.filter(s => s.category === currentFilter);
            }
            
            numberOfOriginalItemsInCarousel = filteredSubmissions.length;

            const itemsForDisplay = [...filteredSubmissions];
            
            // Populate with original items first to calculate width
            itemsForDisplay.forEach(submission => {
                const card = document.createElement('div');
                // Apply responsive min-width using Tailwind classes
                card.className = 'carousel-item gallery-card transform hover:scale-105 transition-transform duration-300 min-w-[260px] xs:min-w-[280px] sm:min-w-[300px]';
                // ... (innerHTML for card remains largely the same, adjust image height class if needed)
                let categoryClass = '';
                let categoryText = submission.category.charAt(0).toUpperCase() + submission.category.slice(1);

                switch(submission.category) {
                    case 'cool': categoryClass = 'category-cool'; break;
                    case 'pop': categoryClass = 'category-pop'; break;
                    case 'natural': categoryClass = 'category-natural'; break;
                    default: categoryClass = 'category-other'; categoryText = 'ãã®ä»–'; break;
                }

                card.innerHTML = `
                    <img src="${submission.imageUrl}" alt="${submission.title}" class="w-full h-[180px] sm:h-[200px] object-cover" onerror="this.onerror=null;this.src='https://placehold.co/300x200/e0e0e0/777777?text=ç”»åƒèª­è¾¼ã‚¨ãƒ©ãƒ¼';">
                    <div class="p-2.5 sm:p-3">
                        <h3 class="text-sm sm:text-base font-semibold mb-0.5 sm:mb-1 truncate" title="${submission.title}">${submission.title}</h3>
                        <p class="text-xs text-gray-500 mb-0.5 sm:mb-1">æŠ•ç¨¿è€…: ${submission.twitter}</p>
                        <p class="text-xs sm:text-sm text-gray-600 mb-1.5 sm:mb-2 h-8 sm:h-10 overflow-hidden">${submission.comment.substring(0, 40)}${submission.comment.length > 40 ? '...' : ''}</p>
                        <div class="mb-2 sm:mb-3">
                           <span class="category-tag ${categoryClass}">${categoryText}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <button class="btn-primary text-xs py-1 px-1.5 sm:py-1 sm:px-2 rounded-md vote-btn focus-ring-black" data-id="${submission.id}">
                                æŠ•ç¥¨ã™ã‚‹ (<span class="vote-count">${submission.votes}</span>)
                            </button>
                            <span class="text-xs text-gray-400">ID: ${submission.id.toString().split('_')[0]}</span>
                        </div>
                    </div>
                `;
                carouselTrack.appendChild(card);
            });

            calculatedItemWidthAndMargin = calculateDynamicItemWidth(); // Calculate actual width

            // Cloning logic based on calculated width
            if (numberOfOriginalItemsInCarousel > 0 && carouselContainer.clientWidth > 0 && (numberOfOriginalItemsInCarousel * calculatedItemWidthAndMargin) > carouselContainer.clientWidth) {
                const clones = filteredSubmissions.map(item => {
                    const cloneCard = carouselTrack.querySelector(`.carousel-item[data-id="${item.id}"]`)?.cloneNode(true) 
                                   || carouselTrack.children[0].cloneNode(true); // Fallback to cloning first if specific not found
                    // Ensure cloned items also get unique IDs for their elements if necessary, but data-id should point to original
                    // The card structure is simple enough that direct cloning should be fine.
                    // Add a marker or different data-id for clones if needed for specific logic, but vote target is original id.
                    return cloneCard;
                });
                 clones.forEach(clone => carouselTrack.appendChild(clone));
            }


            if (carouselTrack.children.length === 0) { // Check after attempting to populate
                carouselTrack.innerHTML = '<p class="text-center text-gray-500 w-full py-8">ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ä½œå“ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                updateCarouselNavVisibility(false);
                return;
            }
            updateCarouselNavVisibility(carouselTrack.scrollWidth > carouselContainer.clientWidth);
            
            addVoteButtonListeners();
            currentTrackPosition = 0;
            carouselTrack.style.transition = 'none'; 
            carouselTrack.style.transform = `translateX(0px)`;
            carouselTrack.offsetHeight; 
            carouselTrack.style.transition = 'transform 0.5s ease-in-out'; 
            
            startAutoScroll();
        }
        
        function updateCarouselNavVisibility(show) {
            const displayStyle = show ? 'block' : 'none';
            prevBtn.style.display = displayStyle;
            nextBtn.style.display = displayStyle;
        }


        function addVoteButtonListeners() {
            document.querySelectorAll('.vote-btn').forEach(button => {
                // Remove old listener before adding new one to prevent multiple fires
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                newButton.addEventListener('click', function() {
                    const submissionId = this.getAttribute('data-id');
                    handleVote(submissionId);
                });
            });
        }

        function handleVote(submissionId) {
            const actualIdString = submissionId.toString().split('_')[0];
            const actualId = parseInt(actualIdString);
            const submission = submissions.find(s => s.id.toString().startsWith(actualIdString)); 

            if (submission) {
                let votedItems = JSON.parse(localStorage.getItem('votedItems_mynoseshop') || '[]');
                if (votedItems.includes(actualId)) {
                    showMessageModal("ã“ã®ä½œå“ã«ã¯æ—¢ã«æŠ•ç¥¨æ¸ˆã¿ã§ã™ã€‚");
                    return;
                }
                submission.votes++;
                votedItems.push(actualId);
                localStorage.setItem('votedItems_mynoseshop', JSON.stringify(votedItems));
                
                document.querySelectorAll(`.vote-btn[data-id^="${actualIdString}"]`).forEach(btn => {
                     btn.querySelector('.vote-count').textContent = submission.votes;
                     btn.classList.remove('btn-primary'); 
                     btn.classList.add('bg-gray-200', 'text-gray-500', 'border-gray-200', 'cursor-not-allowed'); 
                     btn.disabled = true;
                     btn.innerHTML = `æŠ•ç¥¨æ¸ˆã¿ (<span class="vote-count">${submission.votes}</span>)`;
                });
                showMessageModal(`ã€Œ${submission.title}ã€ã«æŠ•ç¥¨ã—ã¾ã—ãŸï¼`);
            }
        }
        
        function startAutoScroll() {
            stopAutoScroll();
            if (carouselTrack.scrollWidth > carouselContainer.clientWidth && numberOfOriginalItemsInCarousel > 0) {
                 autoScrollInterval = setInterval(() => {
                    moveToNextSlide();
                }, 3000);
            }
        }

        function stopAutoScroll() {
            clearInterval(autoScrollInterval);
        }
        
        function moveToNextSlide() {
            if (numberOfOriginalItemsInCarousel === 0 || carouselTrack.scrollWidth <= carouselContainer.clientWidth) {
                stopAutoScroll(); 
                return;
            }

            currentTrackPosition -= calculatedItemWidthAndMargin; // Use dynamic width
            carouselTrack.style.transform = `translateX(${currentTrackPosition}px)`;

            // Loop condition based on original items and dynamic width
            if (currentTrackPosition <= -(numberOfOriginalItemsInCarousel * calculatedItemWidthAndMargin)) {
                const transitionEndHandler = () => {
                    carouselTrack.removeEventListener('transitionend', transitionEndHandler); // Clean up
                    
                    carouselTrack.style.transition = 'none'; 
                    currentTrackPosition += (numberOfOriginalItemsInCarousel * calculatedItemWidthAndMargin);
                    carouselTrack.style.transform = `translateX(${currentTrackPosition}px)`;
                    
                    carouselTrack.offsetHeight; 
                    requestAnimationFrame(() => { // Ensure transition is re-applied in next frame
                        carouselTrack.style.transition = 'transform 0.5s ease-in-out';
                    });
                };
                carouselTrack.addEventListener('transitionend', transitionEndHandler);
            }
        }

        // --- åˆæœŸåŒ–å‡¦ç† ---
        document.addEventListener('DOMContentLoaded', () => {
            renderGallery(); 
            const initialFilterBtn = document.querySelector('.category-filter-btn[data-category="all"]');
            if (initialFilterBtn) {
                initialFilterBtn.classList.add('active');
            }
        });

    </script>
</body>
</html>
